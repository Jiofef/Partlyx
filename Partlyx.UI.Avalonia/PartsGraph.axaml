<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vmo="using:Partlyx.ViewModels.UIObjectViewModels"
             mc:Ignorable="d"
             x:Class="Partlyx.UI.Avalonia.PartsGraph"
             xmlns:beh="clr-namespace:Partlyx.UI.Avalonia.Behaviors"
             xmlns:h="clr-namespace:Partlyx.UI.Avalonia.Helpers"
             xmlns:graphvm="clr-namespace:Partlyx.ViewModels.Graph;assembly=Partlyx.ViewModels"
             xmlns:local="clr-namespace:Partlyx.UI.Avalonia"
             xmlns:localo="clr-namespace:Partlyx.UI.Avalonia.OtherControls"
             xmlns:mdi="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             Background="{StaticResource PxWhiteBrush}"
             x:Name="Root"
             x:DataType="vmo:PartsGraphViewModel"
             x:CompileBindings="false">

        <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="32"/>
            <RowDefinition Height="3"/>
            <RowDefinition Height="152" MinHeight="64"/>
        </Grid.RowDefinitions>


        <Grid h:SizeObserver.Observe="True" h:SizeObserver.BindableWidth="{Binding PanAndZoomController.ElementWidth}"
          h:SizeObserver.BindableHeight="{Binding PanAndZoomController.ElementHeight}"
          h:SizeObserver.SizeChangedCommand="{Binding CenterizePanPositionCommand}"
          h:SizeObserver.OneShotCommand="True">

            <localo:ZoomPanControl PanPositionX="{Binding PanAndZoomController.PanPositionX, Mode=TwoWay}" PanPositionY="{Binding PanAndZoomController.PanPositionY, Mode=TwoWay}" 
                               ZoomLevel="{Binding PanAndZoomController.ZoomLevel, Mode=TwoWay}"
                               MinZoom="{Binding PanAndZoomController.MinZoom}"
                               MaxZoom="{Binding PanAndZoomController.MaxZoom}">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                    <!-- edges behind -->
                    <ItemsControl ItemsSource="{Binding Graph.Edges}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <localo:FromToLineControl From="{Binding From}" To="{Binding To}" Brush="{StaticResource PxBlackBrush}" LineThickness="2"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <!-- nodes on top -->
                    <ItemsControl ItemsSource="{Binding Graph.Nodes}">
                        <ItemsControl.Resources>
                            <DataTemplate x:Key="RecipeNodeTemplate" DataType="{x:Type graphvm:RecipeGraphNodeViewModel}">
                                <Button Width="{Binding Width}" Height="{Binding Height}" Padding="2" Background="{StaticResource PxWhiteBrush}"
                            BorderBrush="{StaticResource PxBlue0Brush}" BorderThickness="2" VerticalContentAlignment="Stretch">
                                    <Grid VerticalAlignment="Stretch">
                                        <StackPanel VerticalAlignment="Bottom" Orientation="Vertical">
                                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Bottom" Text="{Binding Value.UiNode.ColumnText}"/>
                                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding Value.UiNode.SecondaryColumnText}"/>
                                        </StackPanel>
                                    </Grid>

                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Find recipe in tree" Command="{Binding Value.UiNode.FindInTreeCommand}" Classes="common"/>
                                            <MenuItem Header="Find resource in tree" Command="{Binding Value.UiNode.FindResourceInTreeCommand}" Classes="common"/>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                </Button>
                            </DataTemplate>
                            <DataTemplate x:Key="ComponentNodeTemplate" DataType="{x:Type graphvm:ComponentGraphNodeViewModel}">
                                <Button Width="{Binding Width}" Height="{Binding Height}" Padding="2" Background="{StaticResource PxWhiteBrush}"
                                BorderBrush="{StaticResource PxBlue0Brush}" BorderThickness="2"
                                    Command="{Binding Value.UiNode.SetNextSelectedRecipeCommand }" VerticalContentAlignment="Stretch">
                                    <Grid VerticalAlignment="Stretch">
                                        <StackPanel VerticalAlignment="Bottom" Orientation="Vertical">
                                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Bottom" Text="{Binding Value.UiNode.BottomColumnText}"/>
                                            <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" Text="{Binding ColumnText}"/>
                                        </StackPanel>
                                    </Grid>

                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Find in tree" Command="{Binding Value.UiNode.FindResourceInTreeCommand}" Classes="common"/>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.Resources>

                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemContainerTheme>
                            <ControlTheme TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding DataContext.X, RelativeSource={RelativeSource AncestorType=Button}}" />
                                <Setter Property="Canvas.Top"  Value="{Binding DataContext.Y, RelativeSource={RelativeSource AncestorType=Button}}" />
                            </ControlTheme>
                        </ItemsControl.ItemContainerTheme>
                    </ItemsControl>
                </Grid>
            </localo:ZoomPanControl>

            <StackPanel Orientation="Vertical" VerticalAlignment="Top" HorizontalAlignment="Right">
                <Button Classes="base" Command="{Binding CenterizePanPositionCommand}" ToolTip.Tip="{h:Loc Return_to_the_tree_root}">
                    <mdi:MaterialIcon Kind="Home" Foreground="{StaticResource PxBlackBrush}" Width="24" Height="24" Margin="4"/>
                </Button>
                <Separator Height="8"/>
                <Button Classes="base" Command="{Binding ZoomInCommand}" ToolTip.Tip="{h:Loc Zoom_in}">
                    <mdi:MaterialIcon Kind="Plus" Foreground="{StaticResource PxBlackBrush}" Width="16" Height="24"/>
                </Button>
                <Button Classes="base" Command="{Binding ZoomOutCommand}" ToolTip.Tip="{h:Loc Zoom_out}">
                    <mdi:MaterialIcon Kind="Minus" Foreground="{StaticResource PxBlackBrush}" Width="16" Height="24"/>
                </Button>
            </StackPanel>

            <StackPanel Orientation="Vertical" VerticalAlignment="Bottom" HorizontalAlignment="Right">
                <Button Classes="base" Command="{Binding MainWindowController.NameController.RandomizePostfixCommand}" ToolTip.Tip="{h:Loc The_button_that_does_the_weird_thing}" Width="32">
                    <mdi:MaterialIcon Kind="QuestionMark" Foreground="{StaticResource PxBlackBrush}" Width="16" Height="16" Margin="4"/>
                </Button>
            </StackPanel>

        </Grid>

        <GridSplitter Grid.Row="1" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Background="{StaticResource PxBlue1Brush}"/>

        <Grid Grid.Row="2" VerticalAlignment="Stretch"  Background="{StaticResource PxBlue0Brush}">
            <StackPanel Orientation="Vertical" VerticalAlignment="Stretch">
                <TextBlock Text="{h:Loc Total_resources_amount}" Classes="common" HorizontalAlignment="Center"/>
                
                <ScrollViewer VerticalScrollBarVisibility="Disabled" VerticalAlignment="Stretch">
                    <ItemsControl ItemsSource="{Binding SumController.Compilations}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type graphvm:ComponentNodeSumCompilation}">
                                <Button Background="{StaticResource PxWhiteBrush}" Height="128" Width="128" Padding="2"
                                Margin="8, 0, 8, 0"
                                BorderBrush="{StaticResource PxBlue1Brush}" BorderThickness="4"
                                VerticalContentAlignment="Stretch" HorizontalContentAlignment="Stretch">
                                    <Grid VerticalAlignment="Stretch" HorizontalAlignment="Stretch">
                                        <StackPanel VerticalAlignment="Bottom" Orientation="Vertical">
                                            <TextBlock HorizontalAlignment="Center" Text="{Binding ColumnText}"/>
                                            <TextBlock HorizontalAlignment="Center" Text="{Binding BottomColumnText}"/>
                                        </StackPanel>
                                    </Grid>

                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Find in tree" Command="{Binding ComponentsResource.UiItem.FindInTreeCommand}" Classes="common"/>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>

                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Stretch" HorizontalAlignment="Stretch">

                                </StackPanel>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </ScrollViewer>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
